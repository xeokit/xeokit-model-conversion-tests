<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport">
    <meta content="xeokit - SDK for Browser-Based 3D BIM Visualization" name="description">
    <meta content="Lindsay Kay" name="author">
    <meta content="BIM,IFC,WebGL,JavaScript,Browser,BCF,Web,xeolabs,3D,3D Viewer,Lindsay Kay,xeokit,MedViz,ArchViz,Open Source,Browser,Viewer"
          name="keywords">

    <title>xeokit - 3D Web Programming Toolkit for BIM and Engineering Visualization</title>

    <link href="./vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="./css/business-frontpage.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Rubik" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <link href="./css/viewer.css" rel="stylesheet">

    <script src="./vendor/jquery/jquery.min.js"></script>
    <script src="./vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
</head>

<body data-offset="50" data-spy="scroll" data-target=".navbar">

<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top ">
    <span style="color: #ffffff;"><a class="navbar-home" href="http://xeolabs.com">xeolabs</a>/<a class="navbar-parent"
                                                                                                  href="https://xeokit.io">xeokit&nbsp;SDK</a>/<a
            class="navbar-parent" href="./index.html">Model Conversion</a>/<a class="navbar-parent" href="./tests.html">CxConverter #1 Tests</a>/</span><span
        class="navbar-brand" href="./index.html">View XKT</span>
</nav>

<div id="body">
    <div class="row  no-gutters pl-0">
        <div class="col-12 pt-3">
            <div id="modelConversionInfo"></div>
        </div>
    </div>
    <div class="row no-gutters">
        <div class="col-3 pl-2">
            <div class="input-group mb-3">
                <input type="text" id="isolateInput" class="form-control" placeholder="Enter object ID...">
                <div class="input-group-append">
                    <button class="btn btn-primary" type="button" id="isolateButton">Isolate object</button>
                </div>
            </div>
            <h5 class="pt-2 pl-2" id="infoArea">IFC Types:</h5>
            <div id="treeViewContainer"></div>
        </div>
        <div class="col-9 text-center">
            <canvas id="viewerCanvas"/>
        </div>
    </div>
    <canvas id="navCubeCanvas"></canvas>
</div>
</body>

<script type="module">

    async function getXeokitVersion() {
        try {
            const response = await fetch(`https://registry.npmjs.org/@xeokit/xeokit-sdk/latest`);
            const data = await response.json();
            if (data && data.version) {
                return data.version;
            } else {
                return "";
            }
        } catch (error) {
            console.error(`Error: ${error.message}`);
            return "";
        }
    }

    const xeokitVersion = await getXeokitVersion();

    const reqParams = getRequestParams();

    const batchId = reqParams.batchId;
    const modelId = reqParams.modelId;

    function getRequestParams() {
        const vars = {};
        window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, (m, key, value) => {
            vars[key] = value;
        });
        return vars;
    }

    // <table class="table table-sm table-hover table-striped table-bordered mb-0">
    //                     <tbody>
    //                     <tr>
    //                         <td>Converted with</td>
    //
    //                         <td><a href="#ifcCommunityPipeline1"> <a href="index.html#ifcCXConverterPipeline1">CxConverter IFC Pipeline #1</a></a></td>
    //                     </tr>
    //                     <tr>
    //                         <td>Viewing with</td>
    //
    //                         <td><a href="https://github.com/xeokit/xeokit-sdk"><a href="https://github.com/xeokit/xeokit-sdk">@xeokit/xeokit-sdk ${xeokitVersion}</a></a></td>
    //                     </tr>
    //
    //                     <tr>
    //                         <td>Conversion Logs</td>
    //                         <td><a href="#ifcCXConverterPipeline2">CxConverter IFC Conversion Pipeline #2</a></td>
    //                     </tr>
    //                     </tbody>
    //                 </table>
    document.getElementById("modelConversionInfo").innerHTML = `<h1 class="pl-3">${modelId}</h1>

    <a  class="pl-3" href="./results/${batchId}/${modelId}/ifcCXConverterPipeline1/log.txt">Conversion Log</a>
    <br><br>

`;

    import {createViewer, isolateObject} from "./lib/viewer.js";

    const {viewer, xktLoader} = createViewer({
        canvasId: "viewerCanvas",
        navCubeCanvasId: "navCubeCanvas",
        treeViewContainerId: "treeViewContainer"
    });

    document.getElementById("body").style.visibility = "visible";

    const model = xktLoader.load({
        manifestSrc: `./results/${batchId}/${modelId}/ifcCXConverterPipeline1/model.xkt.manifest.json`,
        id: "myModel",
        edges: true,
        saoEnabled: true
    });
    model.on("loaded", () => {
        viewer.camera.eye = [0, 0, 1];
        viewer.camera.look = [0, 0, 0];
        viewer.camera.up = [0, 1, 0];
        viewer. camera.orbitYaw(40.0);
        viewer.camera.orbitPitch(40.0);
        viewer.cameraFlight.jumpTo(viewer.scene);
    });

    function doIsolate() {
        const searchText = document.getElementById('isolateInput').value.trim();
        if (searchText.trim() === '') {
            // document.getElementById('searchResults').innerHTML = '';
            return;
        }
        isolateObject(searchText)
    }

    document.getElementById('isolateButton').addEventListener('click', doIsolate);

    window.viewer = viewer;

</script>

</html>
